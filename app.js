const lyricData = {
    "items": [
        {
            "time": 3722,
            "duration": 3750,
            "words": [
                {
                    "text": "Chromatics ",
                    "duration": 800
                },
                {
                    "text": "- ",
                    "duration": 700
                },
                {
                    "text": "Into ",
                    "duration": 800
                },
                {
                    "text": "The ",
                    "duration": 700
                },
                {
                    "text": "Black",
                    "duration": 750
                }
            ]
        },
        {
            "time": 38535,
            "duration": 3950,
            "words": [
                {
                    "text": "My  ",
                    "duration": 1550
                },
                {
                    "text": "my,  ",
                    "duration": 1150
                },
                {
                    "text": "hey  ",
                    "duration": 750
                },
                {
                    "text": "hey",
                    "duration": 500
                }
            ]
        },
        {
            "time": 47889,
            "duration": 3417,
            "words": [
                {
                    "text": "Rock",
                    "duration": 250
                },
                {
                    "text": "´",
                    "duration": 201
                },
                {
                    "text": "n  ",
                    "duration": 149
                },
                {
                    "text": "roll  ",
                    "duration": 1067
                },
                {
                    "text": "is  ",
                    "duration": 400
                },
                {
                    "text": "here  ",
                    "duration": 400
                },
                {
                    "text": "to  ",
                    "duration": 551
                },
                {
                    "text": "stay",
                    "duration": 399
                }
            ]
        },
        {
            "time": 56614,
            "duration": 5405,
            "words": [
                {
                    "text": "It",
                    "duration": 200
                },
                {
                    "text": "´",
                    "duration": 150
                },
                {
                    "text": "s  ",
                    "duration": 150
                },
                {
                    "text": "better  ",
                    "duration": 150
                },
                {
                    "text": "to  ",
                    "duration": 201
                },
                {
                    "text": "burn  ",
                    "duration": 550
                },
                {
                    "text": "out  ",
                    "duration": 2454
                },
                {
                    "text": "than  ",
                    "duration": 200
                },
                {
                    "text": "to  ",
                    "duration": 150
                },
                {
                    "text": "fade  ",
                    "duration": 349
                },
                {
                    "text": "away",
                    "duration": 851
                }
            ]
        },
        {
            "time": 65502,
            "duration": 3251,
            "words": [
                {
                    "text": "My  ",
                    "duration": 850
                },
                {
                    "text": "my,  ",
                    "duration": 1100
                },
                {
                    "text": "hey  ",
                    "duration": 900
                },
                {
                    "text": "hey!",
                    "duration": 401
                }
            ]
        },
        {
            "time": 83117,
            "duration": 3101,
            "words": [
                {
                    "text": "Out  ",
                    "duration": 250
                },
                {
                    "text": "of  ",
                    "duration": 400
                },
                {
                    "text": "the  ",
                    "duration": 150
                },
                {
                    "text": "blue  ",
                    "duration": 1100
                },
                {
                    "text": "into  ",
                    "duration": 400
                },
                {
                    "text": "the  ",
                    "duration": 351
                },
                {
                    "text": "black",
                    "duration": 450
                }
            ]
        },
        {
            "time": 91172,
            "duration": 4150,
            "words": [
                {
                    "text": "I  ",
                    "duration": 700
                },
                {
                    "text": "give  ",
                    "duration": 350
                },
                {
                    "text": "you  ",
                    "duration": 350
                },
                {
                    "text": "this,  ",
                    "duration": 1000
                },
                {
                    "text": "but  ",
                    "duration": 250
                },
                {
                    "text": "you  ",
                    "duration": 200
                },
                {
                    "text": "pay  ",
                    "duration": 400
                },
                {
                    "text": "for  ",
                    "duration": 400
                },
                {
                    "text": "that",
                    "duration": 500
                }
            ]
        },
        {
            "time": 99750,
            "duration": 6152,
            "words": [
                {
                    "text": "Once  ",
                    "duration": 1400
                },
                {
                    "text": "you",
                    "duration": 250
                },
                {
                    "text": "´",
                    "duration": 201
                },
                {
                    "text": "re  ",
                    "duration": 149
                },
                {
                    "text": "gone,  ",
                    "duration": 1251
                },
                {
                    "text": "you  ",
                    "duration": 200
                },
                {
                    "text": "can",
                    "duration": 150
                },
                {
                    "text": "´",
                    "duration": 150
                },
                {
                    "text": "t  ",
                    "duration": 351
                },
                {
                    "text": "never  ",
                    "duration": 599
                },
                {
                    "text": "come  ",
                    "duration": 900
                },
                {
                    "text": "back",
                    "duration": 551
                }
            ]
        },
        {
            "time": 107347,
            "duration": 5342,
            "words": [
                {
                    "text": "When  ",
                    "duration": 500
                },
                {
                    "text": "you",
                    "duration": 300
                },
                {
                    "text": "´",
                    "duration": 200
                },
                {
                    "text": "re  ",
                    "duration": 441
                },
                {
                    "text": "out  ",
                    "duration": 450
                },
                {
                    "text": "of  ",
                    "duration": 751
                },
                {
                    "text": "the  ",
                    "duration": 299
                },
                {
                    "text": "blue,  ",
                    "duration": 950
                },
                {
                    "text": "into  ",
                    "duration": 650
                },
                {
                    "text": "the  ",
                    "duration": 250
                },
                {
                    "text": "black!",
                    "duration": 551
                }
            ]
        },
        {
            "time": 152721,
            "duration": 4196,
            "words": [
                {
                    "text": "The  ",
                    "duration": 750
                },
                {
                    "text": "king  ",
                    "duration": 350
                },
                {
                    "text": "is  ",
                    "duration": 250
                },
                {
                    "text": "gone  ",
                    "duration": 1245
                },
                {
                    "text": "but  ",
                    "duration": 200
                },
                {
                    "text": "he",
                    "duration": 150
                },
                {
                    "text": "´",
                    "duration": 200
                },
                {
                    "text": "s  ",
                    "duration": 150
                },
                {
                    "text": "not  ",
                    "duration": 200
                },
                {
                    "text": "forgotten",
                    "duration": 701
                }
            ]
        },
        {
            "time": 162492,
            "duration": 3172,
            "words": [
                {
                    "text": "This  ",
                    "duration": 251
                },
                {
                    "text": "is  ",
                    "duration": 199
                },
                {
                    "text": "the  ",
                    "duration": 200
                },
                {
                    "text": "story  ",
                    "duration": 472
                },
                {
                    "text": "of  ",
                    "duration": 700
                },
                {
                    "text": "Johnny  ",
                    "duration": 901
                },
                {
                    "text": "Rotten",
                    "duration": 449
                }
            ]
        },
        {
            "time": 170139,
            "duration": 6549,
            "words": [
                {
                    "text": "It",
                    "duration": 250
                },
                {
                    "text": "´",
                    "duration": 200
                },
                {
                    "text": "s  ",
                    "duration": 0
                },
                {
                    "text": "better  ",
                    "duration": 1318
                },
                {
                    "text": "to  ",
                    "duration": 300
                },
                {
                    "text": "burn  ",
                    "duration": 700
                },
                {
                    "text": "out  ",
                    "duration": 2317
                },
                {
                    "text": "than  ",
                    "duration": 400
                },
                {
                    "text": "it  ",
                    "duration": 200
                },
                {
                    "text": "is  ",
                    "duration": 300
                },
                {
                    "text": "to  ",
                    "duration": 350
                },
                {
                    "text": "rust",
                    "duration": 500
                }
            ]
        },
        {
            "time": 179324,
            "duration": 4104,
            "words": [
                {
                    "text": "The  ",
                    "duration": 699
                },
                {
                    "text": "king  ",
                    "duration": 250
                },
                {
                    "text": "is  ",
                    "duration": 301
                },
                {
                    "text": "gone  ",
                    "duration": 854
                },
                {
                    "text": "but  ",
                    "duration": 450
                },
                {
                    "text": "he",
                    "duration": 250
                },
                {
                    "text": "´",
                    "duration": 200
                },
                {
                    "text": "s ",
                    "duration": 200
                },
                {
                    "text": "not  ",
                    "duration": 300
                },
                {
                    "text": "forgotten",
                    "duration": 600
                }
            ]
        },
        {
            "time": 197667,
            "duration": 3102,
            "words": [
                {
                    "text": "Hey  ",
                    "duration": 852
                },
                {
                    "text": "hey,  ",
                    "duration": 1249
                },
                {
                    "text": "my  ",
                    "duration": 601
                },
                {
                    "text": "my",
                    "duration": 400
                }
            ]
        },
        {
            "time": 206434,
            "duration": 3250,
            "words": [
                {
                    "text": "Rock  ",
                    "duration": 300
                },
                {
                    "text": "and  ",
                    "duration": 350
                },
                {
                    "text": "roll  ",
                    "duration": 1050
                },
                {
                    "text": "can  ",
                    "duration": 349
                },
                {
                    "text": "never  ",
                    "duration": 401
                },
                {
                    "text": "die",
                    "duration": 800
                }
            ]
        },
        {
            "time": 214749,
            "duration": 1901,
            "words": [
                {
                    "text": "There",
                    "duration": 250
                },
                {
                    "text": "´",
                    "duration": 201
                },
                {
                    "text": "s  ",
                    "duration": 199
                },
                {
                    "text": "more  ",
                    "duration": 151
                },
                {
                    "text": "to  ",
                    "duration": 200
                },
                {
                    "text": "the  ",
                    "duration": 350
                },
                {
                    "text": "picture",
                    "duration": 550
                }
            ]
        },
        {
            "time": 219172,
            "duration": 1750,
            "words": [
                {
                    "text": "Than  ",
                    "duration": 250
                },
                {
                    "text": "meets  ",
                    "duration": 500
                },
                {
                    "text": "the  ",
                    "duration": 350
                },
                {
                    "text": "eye",
                    "duration": 650
                }
            ]
        },
        {
            "time": 224163,
            "duration": 322000,
            "words": [
                {
                    "text": "Hey  ",
                    "duration": 900
                },
                {
                    "text": "hey,  ",
                    "duration": 1250
                },
                {
                    "text": "my  ",
                    "duration": 750
                },
                {
                    "text": "my",
                    "duration": 601
                }
            ]
        }
    ],
    "ar": "Chromatics",
    "ti": "Into The Black",
    "by": "",
    "al": "",
    "offset": "0",
    "duration": "323000"
}

let currentTime = 0;

function toHumanDuration(ms) {
    let currentSeconds = Math.floor((ms / 1000) % 60);
    return `${Math.floor((ms / 1000 / 60) << 0)}:${currentSeconds < 9 ? '0' : ''}${currentSeconds}`
}

async function displayLyric({time, duration, words}, lineIndex, nextTime) {
    let lyricContainer = $('#lyric-container');
    let currentLyricHeight = lyricContainer.height();
    let line = $(`p#line_${lineIndex}.line`);
    if (line.first().position().top > (currentLyricHeight / 2)) {
        lyricContainer.animate({scrollTop: lyricContainer.scrollTop() + line.height()}, 300);
    }
    return new Promise((resolve => {
        console.log(`\n----${toHumanDuration(time)}------`);
        let id = setTimeout(async () => {
            line.removeClass('default');
            line.addClass('highlight');
            // console.log('lyric: ');
            for (let [wordIndex, item] of words.entries()) {
                let wordId = await displayWord(item, wordIndex, lineIndex);
                clearTimeout(wordId);
            }
            nextTime = !nextTime ? 1000 : nextTime - currentTime;
            let removeClassId = setTimeout(() => {
                line.removeClass('highlight');
                line.addClass('default');
                clearTimeout(removeClassId);
            }, nextTime > 1000 ? 1000 : nextTime / 2);

            resolve(id);
        }, time - currentTime);
        currentTime = time + duration;
    }))
}

async function displayWord({duration, text}, index, lineIndex) {
    return new Promise((resolve => {
        console.log(text, index);
        $(`#line_${lineIndex} #word_${index}`).css('animation', `pulse ${(duration / 1000).toFixed(1)}s linear 0s alternate 1 forwards`);
        let id = setTimeout(() => {
            resolve(id);
        }, duration);
    }))
}

async function display() {
    displayMusicTime(lyricData.duration);
    for (let index = 0; index < lyricData.items.length; index++) {
        let id = await displayLyric(lyricData.items[index], index, lyricData.items[index + 1] ? lyricData.items[index + 1].time : undefined);
        clearTimeout(id);
    }
}

// display();

//region lyric template
function createWord(id, text) {
    return `<span id="word_${id}" class="word"><span class="word-inner">${text}</span></span>`
}

function createLyricLine(wordArrays, index) {
    return `<div class="row"><p id="line_${index}" class="line default">${
        wordArrays.map((word, index) => createWord(index, word.text)).join('')
    }</p></div>`
}

function parseLyric(data) {
    return data.items.map((item, index) => createLyricLine(item.words, index)).join('').concat(createLyricLine([], data.items.length));
}

//endregion

//region play table
function displayMusicTime(totalTime) {
    $('#total-time').text(toHumanDuration(totalTime));
    let currentTime = 0;
    let musicTimeId = setInterval(() => {
        currentTime += 1000;
        $('#current-time').text(toHumanDuration(currentTime));
        const currentPercent = (currentTime / totalTime) * 100;
        $('#music-line').css('background-size', `${currentPercent}%`);
        $('#music-dot').css('left', `${currentPercent}%`)
        if (currentTime >= totalTime) {
            clearInterval(musicTimeId);
        }
    }, 1000);
}

//endregion

// 'use strict';
//
// async function* run(index=0) {
//    for (const item of lyricData.items){
//        await new Promise(resolve => setTimeout(resolve, 1000));
//        // console.log(JSON.stringify(item));
//        yield JSON.stringify(item);
//        console.log('World');
//    }
// }
//
// const asyncIterator = run();
//
// // Prints "Hello\nWorld"
// (async () => {
//     for await (const val of asyncIterator) {
//         console.log(val); // Prints "Hello"
//     }
// })();
